<!DOCTYPE html>
<html class="x-admin-sm">

    <head>
        <meta charset="UTF-8">
        <META HTTP-EQUIV="pragma" CONTENT="no-cache"> 
        <META HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate"> 
        <META HTTP-EQUIV="expires" CONTENT="0">
        <title>Open Intent Discovery System</title>
        <meta name="renderer" content="webkit">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
        <link rel="stylesheet" href="/static/lib/xadmin/css/font.css">
        <link rel="stylesheet" href="/static/lib/xadmin/css/xadmin.css">
        <script type="text/javascript" src="/static/lib/layui/layui.js" charset="utf-8"></script>
        <script type="text/javascript" src="/static/lib/xadmin/js/xadmin.js"></script>
        <script src="/static/lib/xadmin/js/echarts.min.js"></script>
        <script src="/static/lib/xadmin/js/ecStat.js"></script>
    </head>
    <body>
    
        <div class="layui-fluid">
            <div class="layui-row">
                <div class="layui-card">
                    <div class="layui-card-body ">

                        <div style="font-weight:700; font-size:20px;color:#555555">Open Intent Detection</div>
                        <div style="color:#6F6F6F">--Here,You can detection new intents</div>

                        <form class="layui-form" enctype="multipart/form-data">


                            <div class="layui-form-item layui-form-text">
                                <div class="layui-input-block">
                                    <textarea id='text_example' placeholder="Please select Test Example !" class="layui-textarea"   ></textarea>
                                </div>
                            </div>
                            <div class="layui-input-inline">
                                <div class="layui-input-inline">
                                    <div class="layui-input-inline" >
                                        <div class="layui-form-item" style="position: relative;left: 57%">
                                            <select id="model_detection" name="model_detection" >
                                                <option  selected >Open Intent Detection</option>
                                                    {% for lines in modelList_detection %}
                                                        <option  value="{{lines.model_name}}" >{{lines.model_name}}</option>
                                                    {% endfor %}
                                            </select>
                                        </div>
                                    </div>

                                    <div class="layui-input-inline ">
                                        <div class="layui-form-item" style="position: relative;left: 77%">
                                            <select id = 'example_select_detection' name="example_select_detection" lay-filter="example_select_detection" onclick="switchBySelect()"> 
                                                <option value="" selected>Examples</option>
                                                <option value="1">Example-1</option>
                                                <option value="2">Example-2</option>
                                                <option value="3">Example-3</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                            <div class="layui-card-body ">
                                <div class="layui-input-inline">
                                    <div class="layui-input-inline">
                                        <div class="layui-form-item" style="position:relative">
                                            <button class="layui-btn" lay-filter="detection_test" lay-submit="" style="position: relative;left: 400%">Test</button>
                                        </div>
                                    </div>

                                    <div class="layui-input-inline">
                                        <div class="layui-form-item" style="position:relative">
                                            <button class="layui-btn layui-btn-warm"   style="position: relative;left: 600%" type ='reset'>Clear</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        
                        </form>
                    
                        <div style="font-weight:700; font-size:20px;color:#555555">Model Detail Analysis</div>
                        <div style="color:#6F6F6F">--Show the reasons for the model result</div>
                        
                        <div id="image1" style="width: 800px;height:450px;margin:0 auto;" ></div>
                        {% comment %} 点击事件 {% endcomment %}

                    
                                    
                        
                        
                    </div>
                </div>
            </div>
        </div>
        


        <script>layui.use(['form', 'layer','jquery'],
            function() {
                $ = layui.jquery;
                var form = layui.form,
                layer = layui.layer;


                //监听提交
                form.on('submit(detection_test)',
                function(data) {

                    console.log('data===='+data);
                    
                    var form_data = new FormData();
                    form_data.append('model_detection', $('#model_detection').val());
                    form_data.append('example_select_detection', $('#example_select_detection').val());
                    console.log(form_data);
                    $.ajax({
                        url: "/detection/model_analysis/modelAnalysisTest",
                        type: 'POST',
                        data: form_data,
                        dataType: "json",
                        contentType: false,
                        processData: false,// 获取POST所需的csrftoken
                        success: function (data) {
                            alert(data.msg);
                            if (data.code == 200){
                                // 可以对父窗口进行刷新
                                xadmin.father_reload();
                            }   
                        }

                    }); 
                    //image_show
                    model_detection = $('#model_detection').val()
                    example_select_detection = $('#example_select_detection').val()

                    if(model_detection == 'New Intent Detection'){
                        layer.msg('Please select Model');
                    } else if( example_select_detection == 0){
                        layer.msg('Please select example');
                    }else if(model_detection == 'MSP' || model_detection == 'Deep_unk'){// 渲染图表
                        var myChart2 = echarts.init(document.getElementById('image1'));
                            myChart2.showLoading();
                            var series_bar = [];
                            var legend_bar = [];
                            //get threshold.json
                            $.get('/static/json/my_json.json', function (data) {
                                data_chart_1 = data["bar"];
                                for(var key in data_chart_1){
                                    legend_bar.push(key);
                                    series_bar.push({
                                            name:key,
                                            type: 'bar',
                                            data: data_chart_1[key]
                                        })
                                }
                            },'json');
                            $.get('/static/json/my_json.json', function (data) {
                                data_chart_2 = data["threshold"]
                                myChart2.hideLoading();  // 
                                myChart2.clear();//清除缓存
                                //get /static/json/bar_test.json
                                for(var key in data){
                                    legend_bar.push(key);
                                    series_bar.push({
                                            name: key,
                                            type: 'line',
                                            data: data[key]
                                        })
                                };
                                
                                myChart2.setOption({
                                    title: {
                                        text: '',
                                        subtext: ''
                                    },
                                    tooltip: {
                                        trigger: 'axis',
                                        axisPointer: {
                                            type: 'cross'
                                        }
                                    },
                                    legend: {
                                        data: legend_bar,
                                        bottom:"85%"
                                    },
                                    grid: {
                                        left: '3%',
                                        right: '4%',
                                        bottom: '3%',
                                        top:'20%',
                                        containLabel: true
                                    },
                                    xAxis: {
                                        //name:'Samples',
                                        type: 'category',
                                        data: ['Sample#1', 'Sample#2', 'Sample#3', 'Sample#4', 'Sample#5', 'Sample#6'],
                                    },
                                    yAxis: { 
                                        //name:'Probability',
                                        type: 'value',
                                        boundaryGap: [0, 0.01],
                                    },
                                    series: series_bar,
                            })
                            }, 'json');
                    }else if(model_detection == 'ADB'){// 渲染图表
                        var myChart4 = echarts.init(document.getElementById('image1'));
                           
                            myChart4.hideLoading();
                                            var series = [];//保存散点
                                            var mylegend = [];//legend部分使用
                                            var graphic = [];//保存圆
                                            var r = [];
                                            //get r
                                            $.get('/static/json/my_json.json', function (mydata) {
                                                data_chart_3 = mydata["circle_r"];
                                                 for (var key in data_chart_3){
                                                    r.push(data_chart_3[key])
                                                };
                                                },'json');
                                            //get circle
                                            $.get('/static/json/my_json.json', function (mydata) {
                                                data_chart_4 = mydata["circle_xy"];
                                                var i = 0;
                                                 for (var key in data_chart_4){ 
                                                    mylegend.push(key);
                                                    series.push({
                                                        name:key,
                                                        type:'scatter',
                                                        data:data_chart_4[key],
                                                        symbolSize: r[i],
                                                        itemStyle: {
                                                                borderColor: '#555'
                                                            },
                                                        tooltip: {
                                                             trigger:'item',
                                                             formatter:function(params){
                                                                // console.log(params);
                                                                 var dotHtml1 = '<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:#666666"></span>'
                                                                 mystr ='<span style="font-size:10px;">'+params.seriesName+"</br>"+dotHtml1+"Radius:"+'</span>'+ '<span style="font-weight:800;font-size:14px;">'+"  " +params.data[2]+'</span>'
                                                                 +"</br>"+dotHtml1+"Center:"+'</span>' + '<span style="font-weight:800;font-size:14px;">'+"  " +'('+params.data[0]+','+params.data[1]+')'+'</span>';
                                                                 return mystr;
                                                                // console.log(mystr);
                                                                
                                                             }
                                                             
                                                        },
                                                    });
                                                   i= i+1; 
                                                   //console.log(r[i-1]);
                                                };
                                                },'json');
                                                
                                                //get cluster.json
                                            $.get('/static/json/my_json.json', function (data) {
                                                data_chart_5 = data["cluster"];
                                                myChart4.clear();//清除缓存
                                                //循环显示散点
                                                //换行显示legend
                                                mylegend.push('');
                                                for (var key in data_chart_5){
                                                    mylegend.push(key);
                                                    series.push({
                                                       name:key,
                                                        type:'scatter',
                                                        data:data_chart_5[key],
                                                        itemStyle: {
                                                                borderColor: '#555'
                                                            },
                                                         tooltip: {
                                                             trigger:'item',
                                                             formatter:function(params){
                                                                 //console.log(params);                                                             
                                                                 var dotHtml2 = '<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:#666666"></span>'
                                                                 mystr ='<span style="font-size:10px;">'+params.seriesName+"</br>"+dotHtml2+"Density:"+'</span>' + '<span style="font-weight:800;font-size:14px;">'+"  " +params.data[2]+'</span>'+"</br>"+dotHtml2+"Center:"+'</span>' + '<span style="font-weight:800;font-size:14px;">'+"  " +'('+params.data[0]+','+params.data[1]+')'+'</span>';
                                                                 return mystr;
                                                                 //console.log(params);
                                                             }
                                                             
                                                        }
                                                    });
                                                };
                                                myChart4.setOption({
                                                        xAxis: {name:'X'},
                                                        yAxis: {name:'Y'},
                                                        legend: {
                                                          data:mylegend
                                                          //data:["cluster1","cluster2","cluster3","cluster4"]
                                                          },
                                                        tooltip: {
                                                        },
                                                        series: series,
                                                    //画圆
                                                       graphic:graphic,
                                                 })
                                            }, 'json');
                    }
                    return false;
                });


                //样例选择监听
                 form.on('select(example_select_detection)', function(data) {
                    switchBySelect();
                });
                form.on('select(example_select_discovery)', function(data) {
                    discovery_switchBySelect();
                });
            });
        </script>

        <script type="text/javascript">

            function switchBySelect() {
                // alert('点击select框了')
                var v = $("#example_select_detection").find("option:selected").text();//得到下拉框的value值
                // alert(v)
                // console.log(v);
                var form_data = new FormData();
                form_data.append('example_num', v);
                $.ajax({
                        url: "/detection/model_analysis/getModelAnalysisExampleData",
                        type: 'POST',
                        data: form_data,
                        dataType: "json",
                        contentType: false,
                        processData: false,// 获取POST所需的csrftoken
                        success: function (data) {
                            if (data.code == 200){
                                document.getElementById("text_example").value = data.text
                            }else{
                                alert('Chose Error !')
                            }

                        }

                });

            }
             function discovery_switchBySelect() {
                // alert('点击select框了')
                var v = $("#example_select_discovery").find("option:selected").text();//得到下拉框的value值
                // alert(v)
                // console.log(v);
                var form_data = new FormData();
                form_data.append('example_num', v);
                $.ajax({
                        url: "/log_management/discovery_getExampleData/",
                        type: 'POST',
                        data: form_data,
                        dataType: "json",
                        contentType: false,
                        processData: false,// 获取POST所需的csrftoken
                        success: function (data) {
                            if (data.code == 200){
                                document.getElementById("discovery_text_example").value = data.text
                            }else{
                                alert('Chose Error !')
                            }
                        }
                });
            }
        </script>


        <script>var _hmt = _hmt || []; (function() {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?b393d153aeb26b46e9431fabaf0f6190";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
            })();</script>
    </body>

</html>